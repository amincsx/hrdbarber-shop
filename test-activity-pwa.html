<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ PWA</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: rgba(59, 130, 246, 0.5);
        }

        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .success {
            color: #22c55e;
        }

        .error {
            color: #ef4444;
        }

        .info {
            color: #3b82f6;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” ØªØ³Øª ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ PWA</h1>
        <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ùˆ Ø¯ÛŒØ¨Ø§Ú¯ Ù…Ø´Ú©Ù„ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª PWA Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>

        <div class="test-section">
            <h3>ğŸ“± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø­ÛŒØ·</h3>
            <div id="environment-info"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª API ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</h3>
            <input type="text" id="barberId" placeholder="Ù†Ø§Ù… Ø¢Ø±Ø§ÛŒØ´Ú¯Ø± (Ù…Ø«Ù„: Ø§Ù…ÛŒÙ†)"
                style="width: 200px; padding: 8px; margin: 5px;">
            <button onclick="testActivityAPI()">ØªØ³Øª API</button>
            <div id="activity-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”‘ ØªØ³Øª VAPID Keys</h3>
            <button onclick="testVAPIDKeys()">Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ VAPID</button>
            <div id="vapid-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¾ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Session</h3>
            <button onclick="checkSession()">Ø¨Ø±Ø±Ø³ÛŒ Session</button>
            <div id="session-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ ØªØ³Øª Ú©Ø§Ù…Ù„</h3>
            <button onclick="runCompleteTest()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„</button>
            <div id="complete-log" class="log"></div>
        </div>
    </div>

    <script>
        // Initialize environment info
        document.addEventListener('DOMContentLoaded', () => {
            showEnvironmentInfo();
        });

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function showEnvironmentInfo() {
            const info = document.getElementById('environment-info');
            const isPWA = window.matchMedia('(display-mode: standalone)').matches;
            const urlParams = new URLSearchParams(window.location.search);

            info.innerHTML = `
                <div class="log">
                    <div class="info">ğŸŒ URL: ${window.location.href}</div>
                    <div class="info">ğŸ“± PWA Mode: ${isPWA ? 'Yes' : 'No'}</div>
                    <div class="info">ğŸ”— PWA Parameter: ${urlParams.get('pwa') || 'None'}</div>
                    <div class="info">ğŸ• Timestamp: ${new Date().toLocaleString('fa-IR')}</div>
                    <div class="info">ğŸ”§ User Agent: ${navigator.userAgent}</div>
                    <div class="info">ğŸ  Origin: ${window.location.origin}</div>
                </div>
            `;
        }

        async function testActivityAPI() {
            const barberId = document.getElementById('barberId').value || 'Ø§Ù…ÛŒÙ†';
            const logId = 'activity-log';

            document.getElementById(logId).innerHTML = '';
            log(logId, `ğŸ” Testing activities API for: ${barberId}`, 'info');

            try {
                const url = `/api/barber-activities/${encodeURIComponent(barberId)}`;
                log(logId, `ğŸ“¡ Calling: ${url}`, 'info');

                const response = await fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                log(logId, `ğŸ“Š Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(logId, `âœ… Success! Activities: ${data.activities?.length || 0}, Unread: ${data.unreadCount || 0}`, 'success');

                    if (data.debug) {
                        log(logId, `ğŸ”§ Debug info: ${JSON.stringify(data.debug, null, 2)}`, 'info');
                    }

                    if (data.activities && data.activities.length > 0) {
                        log(logId, `ğŸ“‹ Sample activity: ${JSON.stringify(data.activities[0], null, 2)}`, 'info');

                        // Check activity ordering
                        log(logId, `ğŸ“… Activity timestamps (first 3):`, 'info');
                        data.activities.slice(0, 3).forEach((activity, i) => {
                            log(logId, `   ${i + 1}. ${activity.customer_name} - ${activity.action}`, 'info');
                            log(logId, `      createdAt: ${activity.createdAt || 'N/A'}`, 'info');
                            log(logId, `      created_at: ${activity.created_at || 'N/A'}`, 'info');
                            log(logId, `      _id: ${activity._id}`, 'info');
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log(logId, `âŒ Error: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(logId, `ğŸ’¥ Network error: ${error.message}`, 'error');
            }
        }

        async function testVAPIDKeys() {
            const logId = 'vapid-log';
            document.getElementById(logId).innerHTML = '';
            log(logId, 'ğŸ”‘ Testing VAPID keys...', 'info');

            try {
                const response = await fetch('/api/push/public-key', {
                    cache: 'no-store'
                });

                log(logId, `ğŸ“Š VAPID API status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(logId, `âœ… VAPID configured: ${data.configured ? 'Yes' : 'No'}`, data.configured ? 'success' : 'error');
                    log(logId, `ğŸ”§ Environment: ${data.environment}`, 'info');
                    log(logId, `ğŸ”‘ Public key length: ${data.publicKey ? data.publicKey.length : 0}`, 'info');
                } else {
                    const errorData = await response.json();
                    log(logId, `âŒ VAPID error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                log(logId, `ğŸ’¥ VAPID test failed: ${error.message}`, 'error');
            }
        }

        function checkSession() {
            const logId = 'session-log';
            document.getElementById(logId).innerHTML = '';
            log(logId, 'ğŸ’¾ Checking session data...', 'info');

            try {
                const barberSession = localStorage.getItem('barberSession');
                const ownerSession = localStorage.getItem('ownerSession');

                if (barberSession) {
                    const parsed = JSON.parse(barberSession);
                    log(logId, `ğŸ‘¨â€ğŸ’¼ Barber session found:`, 'success');
                    log(logId, `   - Name: ${parsed.user?.name || 'N/A'}`, 'info');
                    log(logId, `   - Username: ${parsed.user?.username || 'N/A'}`, 'info');
                    log(logId, `   - ID: ${parsed.user?._id || 'N/A'}`, 'info');
                    log(logId, `   - PWA: ${parsed.pwa || 'No'}`, 'info');
                    log(logId, `   - Auto: ${parsed.auto || 'No'}`, 'info');
                } else {
                    log(logId, 'âŒ No barber session found', 'error');
                }

                if (ownerSession) {
                    log(logId, 'ğŸ‘‘ Owner session detected', 'success');
                } else {
                    log(logId, 'â„¹ï¸ No owner session', 'info');
                }
            } catch (error) {
                log(logId, `ğŸ’¥ Session check failed: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            const logId = 'complete-log';
            document.getElementById(logId).innerHTML = '';
            log(logId, 'ğŸš€ Starting complete test...', 'info');

            // Test 1: Environment
            log(logId, 'ğŸ“± Environment check...', 'info');
            const isPWA = window.matchMedia('(display-mode: standalone)').matches;
            log(logId, `   PWA Mode: ${isPWA}`, isPWA ? 'success' : 'info');

            // Test 2: Session
            log(logId, 'ğŸ’¾ Session check...', 'info');
            const barberSession = localStorage.getItem('barberSession');
            if (barberSession) {
                const parsed = JSON.parse(barberSession);
                log(logId, `   Session user: ${parsed.user?.name || parsed.user?.username}`, 'success');
            } else {
                log(logId, '   No session found', 'error');
            }

            // Test 3: VAPID
            log(logId, 'ğŸ”‘ VAPID keys check...', 'info');
            try {
                const vapidResponse = await fetch('/api/push/public-key');
                if (vapidResponse.ok) {
                    const vapidData = await vapidResponse.json();
                    log(logId, `   VAPID: ${vapidData.configured ? 'OK' : 'Failed'}`, vapidData.configured ? 'success' : 'error');
                }
            } catch (e) {
                log(logId, '   VAPID: Failed', 'error');
            }

            // Test 4: Activity API
            log(logId, 'ğŸ“Š Activity API check...', 'info');
            const testBarberId = document.getElementById('barberId').value || 'Ø§Ù…ÛŒÙ†';
            try {
                const activityResponse = await fetch(`/api/barber-activities/${encodeURIComponent(testBarberId)}`);
                if (activityResponse.ok) {
                    const activityData = await activityResponse.json();
                    log(logId, `   Activities: ${activityData.activities?.length || 0} found`, 'success');
                } else {
                    log(logId, `   Activities: Failed (${activityResponse.status})`, 'error');
                }
            } catch (e) {
                log(logId, '   Activities: Network error', 'error');
            }

            log(logId, 'âœ… Complete test finished!', 'success');
        }
    </script>
</body>

</html>