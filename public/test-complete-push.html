<!DOCTYPE html>
<html>

<head>
    <title>Complete Push Test - Booking to Notification</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
        }

        .log {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007cba;
        }

        .success {
            border-left-color: #28a745;
        }

        .error {
            border-left-color: #dc3545;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <h1>Complete Push Notification Test</h1>
    <p>This test simulates the complete flow: barber subscribes â†’ user makes booking â†’ barber gets push notification</p>

    <div class="step">
        <h3>Step 1: Setup Push for Test Barber</h3>
        <button onclick="setupBarberPush()">Setup Push for Test Barber</button>
    </div>

    <div class="step">
        <h3>Step 2: Create Test Booking</h3>
        <button onclick="createTestBooking()">Create Test Booking (triggers notification)</button>
    </div>

    <div class="step">
        <h3>Step 3: Manual Test</h3>
        <button onclick="sendDirectNotification()">Send Direct Notification to Test Barber</button>
    </div>

    <div id="logs"></div>

    <script>
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').prepend(div);
            console.log(message);
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function setupBarberPush() {
            try {
                log('Starting barber push setup...', 'log');

                // 1. Request permission
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    throw new Error('Notification permission not granted');
                }
                log('âœ… Notification permission granted', 'success');

                // 2. Get VAPID key
                const keyResponse = await fetch('/api/push/public-key');
                const keyData = await keyResponse.json();
                if (!keyData.publicKey) {
                    throw new Error('No VAPID public key');
                }
                log('âœ… VAPID public key obtained', 'success');

                // 3. Register service worker
                const registration = await navigator.serviceWorker.register('/barber-sw.js');
                await navigator.serviceWorker.ready;
                log('âœ… Service worker registered', 'success');

                // 4. Subscribe to push
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(keyData.publicKey)
                });
                log('âœ… Push subscription created', 'success');

                // 5. Save subscription for test barber
                const subResponse = await fetch('/api/barber/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        barberId: 'test-barber',
                        subscription: subscription.toJSON()
                    })
                });

                if (subResponse.ok) {
                    log('âœ… Test barber subscribed successfully!', 'success');
                    log('ðŸ”” Ready to receive notifications', 'success');
                } else {
                    throw new Error('Failed to save subscription');
                }

            } catch (error) {
                log(`âŒ Setup failed: ${error.message}`, 'error');
            }
        }

        async function createTestBooking() {
            try {
                log('Creating test booking...', 'log');

                const bookingData = {
                    user_id: 'test-user-123',
                    user_name: 'Ù…Ø´ØªØ±ÛŒ ØªØ³Øª',
                    user_phone: '09123456789',
                    date_key: new Date().toISOString().split('T')[0], // Today
                    start_time: '14:30',
                    end_time: '15:30',
                    barber: 'test-barber',
                    services: ['Ø§ØµÙ„Ø§Ø­ Ù…ÙˆÛŒ Ø³Ø±', 'Ø§ØµÙ„Ø§Ø­ ØµÙˆØ±Øª'],
                    total_duration: 60
                };

                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();

                if (response.ok) {
                    log('âœ… Test booking created successfully!', 'success');
                    log(`ðŸ“… Booking: ${result.booking.user_name} at ${result.booking.start_time}`, 'success');
                    log('ðŸ”” Push notification should have been sent to test-barber', 'success');
                } else {
                    log(`âŒ Booking failed: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`âŒ Booking error: ${error.message}`, 'error');
            }
        }

        async function sendDirectNotification() {
            try {
                log('Sending direct notification...', 'log');

                const response = await fetch('/api/barber/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        barberId: 'test-barber',
                        title: 'ðŸ§ª ØªØ³Øª Ù…Ø³ØªÙ‚ÛŒÙ…',
                        body: 'Ø§ÛŒÙ† ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ³Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø³Øª Ú©Ù‡ Ø§Ø² Ø·Ø±ÛŒÙ‚ API Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡',
                        data: { test: true }
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    log('âœ… Direct notification sent!', 'success');
                    log(`ðŸ“± Result: ${JSON.stringify(result)}`, 'log');
                } else {
                    log(`âŒ Notification failed: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`âŒ Notification error: ${error.message}`, 'error');
            }
        }
    </script>
</body>

</html>