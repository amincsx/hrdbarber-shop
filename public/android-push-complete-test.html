<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”” Android Push Notification Test - HRD Barber</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .step {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #007bff;
        }

        .step.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .step.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        .alert {
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ff9800;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .device-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”” Android Push Notification Test</h1>
            <p>ØªØ³Øª Ø³ÛŒØ³ØªÙ…Ø§ØªÛŒÚ© Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù‡Ø§ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯</p>
        </div>

        <div class="device-info" id="deviceInfo">
            <h3>ğŸ“± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªÚ¯Ø§Ù‡</h3>
            <div id="deviceDetails">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>

        <div class="step" id="step1">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 1: Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±</h3>
            <p>Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Service Worker Ùˆ Push Manager</p>
            <button onclick="checkBrowserSupport()">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</button>
            <div class="result" id="supportResult"></div>
        </div>

        <div class="step" id="step2">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</h3>
            <p>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</p>
            <button onclick="requestNotificationPermission()">ğŸ”” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ</button>
            <div class="result" id="permissionResult"></div>
        </div>

        <div class="step" id="step3">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 3: Ø«Ø¨Øª Service Worker</h3>
            <p>Ø«Ø¨Øª Ùˆ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Service Worker Ø§Ø®ØªØµØ§ØµÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯</p>
            <button onclick="registerServiceWorker()">âš™ï¸ Ø«Ø¨Øª Service Worker</button>
            <div class="result" id="swResult"></div>
        </div>

        <div class="step" id="step4">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 4: Ø¯Ø±ÛŒØ§ÙØª VAPID Key</h3>
            <p>Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ VAPID Ø§Ø² Ø³Ø±ÙˆØ±</p>
            <button onclick="getVapidKey()">ğŸ”‘ Ø¯Ø±ÛŒØ§ÙØª VAPID Key</button>
            <div class="result" id="vapidResult"></div>
        </div>

        <div class="step" id="step5">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 5: Ø§ÛŒØ¬Ø§Ø¯ Push Subscription</h3>
            <p>Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ú© Push Notification</p>
            <button onclick="subscribeToPush()">ğŸ“§ Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ú©</button>
            <div class="result" id="subscriptionResult"></div>
        </div>

        <div class="step" id="step6">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 6: ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø­Ù„ÛŒ</h3>
            <p>ØªØ³Øª Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø¯ÙˆÙ† Ø³Ø±ÙˆØ±</p>
            <button onclick="showLocalNotification()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø­Ù„ÛŒ</button>
            <div class="result" id="localNotifResult"></div>
        </div>

        <div class="step" id="step7">
            <h3>Ù…Ø±Ø­Ù„Ù‡ 7: ØªØ³Øª Push Ø§Ø² Ø³Ø±ÙˆØ±</h3>
            <p>Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ø³Ø±ÙˆØ±</p>
            <button onclick="testServerPush()">ğŸš€ ØªØ³Øª Push Ø³Ø±ÙˆØ±</button>
            <div class="result" id="serverPushResult"></div>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="alert">
            <strong>âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯:</strong><br>
            â€¢ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª Desktop Ù†ÛŒØ³Øª<br>
            â€¢ Chrome Ø¨Ø§ÛŒØ¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯<br>
            â€¢ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ù‡ÛŒØ¯<br>
            â€¢ Ø§Ø² Ø­Ø§Ù„Øª Ù…Ø±ÙˆØ± Ø®ØµÙˆØµÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯<br>
            â€¢ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ø¨Ø§ØªØ±ÛŒ Optimization Ø®Ø§Ù…ÙˆØ´ Ø§Ø³Øª
        </div>

        <div class="info">
            <h4>ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ú©Ù„ÛŒ:</h4>
            <div id="overallResults">ØªØ³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¢ØºØ§Ø² Ú©Ù†ÛŒØ¯...</div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let vapidKey = '';
        let registration = null;
        let subscription = null;

        // Update device info
        function updateDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                serviceWorkerSupport: 'serviceWorker' in navigator,
                pushManagerSupport: 'PushManager' in window,
                notificationSupport: 'Notification' in window,
                isAndroid: /Android/i.test(navigator.userAgent),
                isChrome: /Chrome/i.test(navigator.userAgent) && !/Edg/i.test(navigator.userAgent),
                isMobile: /Mobi|Android/i.test(navigator.userAgent),
                screen: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                timestamp: new Date().toLocaleString('fa-IR')
            };

            document.getElementById('deviceDetails').innerHTML = Object.entries(info)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
        }

        function updateProgress(step) {
            currentStep = step;
            const progress = (step / 7) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function setStepStatus(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = `step ${status}`;
        }

        function logResult(elementId, result, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const message = `[${timestamp}] ${result}`;

            element.textContent = element.textContent + '\n' + message;
            element.scrollTop = element.scrollHeight;

            console.log(isError ? 'ERROR:' : 'LOG:', message);
        }

        async function checkBrowserSupport() {
            updateProgress(1);
            logResult('supportResult', 'ğŸ” Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±...');

            try {
                const support = {
                    serviceWorker: 'serviceWorker' in navigator,
                    pushManager: 'PushManager' in window,
                    notification: 'Notification' in window,
                    isSecure: location.protocol === 'https:' || location.hostname === 'localhost',
                    isAndroid: /Android/i.test(navigator.userAgent),
                    chrome: /Chrome/i.test(navigator.userAgent)
                };

                logResult('supportResult', `Service Worker: ${support.serviceWorker ? 'âœ…' : 'âŒ'}`);
                logResult('supportResult', `Push Manager: ${support.pushManager ? 'âœ…' : 'âŒ'}`);
                logResult('supportResult', `Notifications: ${support.notification ? 'âœ…' : 'âŒ'}`);
                logResult('supportResult', `HTTPS/Localhost: ${support.isSecure ? 'âœ…' : 'âŒ'}`);
                logResult('supportResult', `Android Device: ${support.isAndroid ? 'âœ…' : 'âŒ'}`);
                logResult('supportResult', `Chrome Browser: ${support.chrome ? 'âœ…' : 'âŒ'}`);

                const allSupported = Object.values(support).every(Boolean);

                if (allSupported) {
                    setStepStatus(1, 'success');
                    logResult('supportResult', 'ğŸ‰ Ù‡Ù…Ù‡ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯!');
                } else {
                    setStepStatus(1, 'error');
                    logResult('supportResult', 'âŒ Ø¨Ø±Ø®ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯', true);
                }

            } catch (error) {
                setStepStatus(1, 'error');
                logResult('supportResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: ${error.message}`, true);
            }
        }

        async function requestNotificationPermission() {
            updateProgress(2);
            logResult('permissionResult', 'ğŸ”” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†...');

            try {
                if (!('Notification' in window)) {
                    throw new Error('Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                }

                const currentPermission = Notification.permission;
                logResult('permissionResult', `ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: ${currentPermission}`);

                if (currentPermission === 'default') {
                    logResult('permissionResult', 'ğŸ“± Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ø¬Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ...');
                    const permission = await Notification.requestPermission();
                    logResult('permissionResult', `Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ${permission}`);
                } else {
                    logResult('permissionResult', `Ø¯Ø³ØªØ±Ø³ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡: ${currentPermission}`);
                }

                const finalPermission = Notification.permission;

                if (finalPermission === 'granted') {
                    setStepStatus(2, 'success');
                    logResult('permissionResult', 'âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!');
                } else if (finalPermission === 'denied') {
                    setStepStatus(2, 'error');
                    logResult('permissionResult', 'âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø¯ Ø´Ø¯', true);
                } else {
                    setStepStatus(2, 'warning');
                    logResult('permissionResult', 'âš ï¸ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
                }

            } catch (error) {
                setStepStatus(2, 'error');
                logResult('permissionResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ: ${error.message}`, true);
            }
        }

        async function registerServiceWorker() {
            updateProgress(3);
            logResult('swResult', 'âš™ï¸ Ø´Ø±ÙˆØ¹ Ø«Ø¨Øª Service Worker...');

            try {
                if (!('serviceWorker' in navigator)) {
                    throw new Error('Service Worker Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯');
                }

                // Detect Android for enhanced service worker
                const isAndroid = /Android/i.test(navigator.userAgent);
                const swPath = isAndroid ? '/barber-sw-android.js' : '/barber-sw.js';

                logResult('swResult', `ğŸ“± Android detected: ${isAndroid}`);
                logResult('swResult', `ğŸ“„ Service Worker path: ${swPath}`);

                // Unregister existing workers first
                const existingRegistrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of existingRegistrations) {
                    await reg.unregister();
                    logResult('swResult', `ğŸ—‘ï¸ Unregistered existing SW: ${reg.scope}`);
                }

                // Register new service worker
                registration = await navigator.serviceWorker.register(swPath, {
                    scope: '/'
                });

                logResult('swResult', `âœ… Service Worker registered successfully`);
                logResult('swResult', `ğŸ“ Scope: ${registration.scope}`);
                logResult('swResult', `ğŸ†” Registration ID: ${registration.active?.scriptURL || 'pending'}`);

                // Wait for service worker to be ready
                await navigator.serviceWorker.ready;
                logResult('swResult', 'ğŸš€ Service Worker is ready!');

                // Test communication with service worker
                const channel = new MessageChannel();
                channel.port1.onmessage = (event) => {
                    logResult('swResult', `ğŸ’¬ SW Response: ${JSON.stringify(event.data)}`);
                };

                navigator.serviceWorker.controller?.postMessage({ type: 'PING' }, [channel.port2]);

                setStepStatus(3, 'success');

            } catch (error) {
                setStepStatus(3, 'error');
                logResult('swResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Service Worker: ${error.message}`, true);
            }
        }

        async function getVapidKey() {
            updateProgress(4);
            logResult('vapidResult', 'ğŸ”‘ Ø¯Ø±ÛŒØ§ÙØª VAPID Key Ø§Ø² Ø³Ø±ÙˆØ±...');

            try {
                const response = await fetch('/api/barber/vapid-key');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                vapidKey = data.publicKey;

                logResult('vapidResult', 'âœ… VAPID Key Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
                logResult('vapidResult', `ğŸ”‘ Public Key: ${vapidKey.substring(0, 50)}...`);
                logResult('vapidResult', `ğŸ“ Key Length: ${vapidKey.length}`);

                setStepStatus(4, 'success');

            } catch (error) {
                setStepStatus(4, 'error');
                logResult('vapidResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª VAPID Key: ${error.message}`, true);

                // Try with fallback key
                vapidKey = 'BGhECE76AktsUUL4OjcT4lifhurEmWkMfFh_AaAhw_MSahdTwi6Fzh2PrGPQ8969n5lj6GINXYK5hlg0rAYWuuM';
                logResult('vapidResult', 'ğŸ”„ Using fallback VAPID key');
            }
        }

        async function subscribeToPush() {
            updateProgress(5);
            logResult('subscriptionResult', 'ğŸ“§ Ø§ÛŒØ¬Ø§Ø¯ Push Subscription...');

            try {
                if (!registration) {
                    throw new Error('Service Worker Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }

                if (!vapidKey) {
                    throw new Error('VAPID Key Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
                }

                // Convert VAPID key to Uint8Array
                function urlBase64ToUint8Array(base64String) {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                    const rawData = window.atob(base64);
                    const outputArray = new Uint8Array(rawData.length);
                    for (let i = 0; i < rawData.length; ++i) {
                        outputArray[i] = rawData.charCodeAt(i);
                    }
                    return outputArray;
                }

                const applicationServerKey = urlBase64ToUint8Array(vapidKey);
                logResult('subscriptionResult', 'ğŸ”„ Converting VAPID key...');

                // Subscribe to push notifications
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                logResult('subscriptionResult', 'âœ… Push Subscription created successfully!');
                logResult('subscriptionResult', `ğŸ“ Endpoint: ${subscription.endpoint.substring(0, 100)}...`);
                logResult('subscriptionResult', `ğŸ”‘ Keys: ${Object.keys(subscription.toJSON().keys || {}).join(', ')}`);

                // Send subscription to server
                const response = await fetch('/api/barber/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barberId: 'test-android',
                        subscription: subscription.toJSON()
                    })
                });

                if (response.ok) {
                    logResult('subscriptionResult', 'âœ… Subscription registered on server');
                    setStepStatus(5, 'success');
                } else {
                    const errorText = await response.text();
                    logResult('subscriptionResult', `âš ï¸ Server registration failed: ${response.status} - ${errorText}`);
                    setStepStatus(5, 'warning');
                }

            } catch (error) {
                setStepStatus(5, 'error');
                logResult('subscriptionResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ú©: ${error.message}`, true);
            }
        }

        async function showLocalNotification() {
            updateProgress(6);
            logResult('localNotifResult', 'ğŸ”” ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø­Ù„ÛŒ...');

            try {
                if (Notification.permission !== 'granted') {
                    throw new Error('Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø§Ø¹Ø·Ø§ Ù†Ø´Ø¯Ù‡');
                }

                if (!registration) {
                    throw new Error('Service Worker Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }

                // Show notification through service worker
                await registration.showNotification('ğŸ‰ ØªØ³Øª Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ù…ÙˆÙÙ‚!', {
                    body: 'Ø§ÛŒÙ† ÛŒÚ© Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ØªØ³Øª Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§Ø³Øª',
                    icon: '/icon-192x192.svg',
                    badge: '/icon-192x192.svg',
                    tag: 'android-test',
                    requireInteraction: true,
                    vibrate: [200, 100, 200, 100, 200],
                    actions: [
                        {
                            action: 'view',
                            title: 'ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡',
                            icon: '/icon-192x192.svg'
                        },
                        {
                            action: 'close',
                            title: 'âŒ Ø¨Ø³ØªÙ†',
                            icon: '/icon-192x192.svg'
                        }
                    ],
                    data: {
                        url: window.location.href,
                        timestamp: Date.now()
                    },
                    dir: 'rtl',
                    lang: 'fa'
                });

                logResult('localNotifResult', 'âœ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø­Ù„ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!');
                logResult('localNotifResult', 'ğŸ‘€ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯');
                setStepStatus(6, 'success');

            } catch (error) {
                setStepStatus(6, 'error');
                logResult('localNotifResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†: ${error.message}`, true);
            }
        }

        async function testServerPush() {
            updateProgress(7);
            logResult('serverPushResult', 'ğŸš€ ØªØ³Øª Push Ø§Ø² Ø³Ø±ÙˆØ±...');

            try {
                if (!subscription) {
                    throw new Error('Push Subscription Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }

                const response = await fetch('/api/barber/notify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barberId: 'test-android',
                        message: {
                            title: 'ğŸš€ ØªØ³Øª Ø³Ø±ÙˆØ± Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯',
                            body: 'Ø§ÛŒÙ† Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø§Ø² Ø³Ø±ÙˆØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª',
                            data: {
                                url: window.location.href,
                                timestamp: Date.now(),
                                test: true
                            }
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    logResult('serverPushResult', 'âœ… Push notification sent from server!');
                    logResult('serverPushResult', `ğŸ“Š Response: ${JSON.stringify(result, null, 2)}`);
                    logResult('serverPushResult', 'ğŸ‘€ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯');
                    setStepStatus(7, 'success');
                } else {
                    const errorText = await response.text();
                    logResult('serverPushResult', `âŒ Server push failed: ${response.status} - ${errorText}`, true);
                    setStepStatus(7, 'error');
                }

            } catch (error) {
                setStepStatus(7, 'error');
                logResult('serverPushResult', `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø² Ø³Ø±ÙˆØ±: ${error.message}`, true);
            }

            updateOverallResults();
        }

        function updateOverallResults() {
            const steps = [
                { id: 'step1', name: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±' },
                { id: 'step2', name: 'Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†' },
                { id: 'step3', name: 'Service Worker' },
                { id: 'step4', name: 'VAPID Key' },
                { id: 'step5', name: 'Push Subscription' },
                { id: 'step6', name: 'Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø­Ù„ÛŒ' },
                { id: 'step7', name: 'Push Ø³Ø±ÙˆØ±' }
            ];

            const results = steps.map(step => {
                const element = document.getElementById(step.id);
                const status = element.classList.contains('success') ? 'âœ…' :
                    element.classList.contains('error') ? 'âŒ' :
                        element.classList.contains('warning') ? 'âš ï¸' : 'â³';
                return `${status} ${step.name}`;
            }).join('<br>');

            document.getElementById('overallResults').innerHTML = results;
        }

        // Initialize device info
        updateDeviceInfo();

        // Listen for service worker messages
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                console.log('ğŸ’¬ Message from SW:', event.data);
                if (event.data.type === 'NOTIFICATION_CLICKED') {
                    alert('ğŸ‰ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ú©Ù„ÛŒÚ© Ø´Ø¯!');
                }
            });
        }

        console.log('ğŸ”” Android Push Test Page loaded successfully');
    </script>
</body>

</html>